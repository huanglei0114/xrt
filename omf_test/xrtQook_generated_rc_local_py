# -*- coding: utf-8 -*-
"""

__author__ = "Konstantin Klementiev", "Roman Chernikov"
__date__ = "2025-08-22"

Created with xrtQook




"""

import numpy as np
import sys
sys.path.append(r"/Users/lhuang/Documents/GitHub/xrt")
#sys.path.append(r"C:\xrt_dev\xrt-1.6.0")
import xrt.backends.raycing.sources as rsources
import xrt.backends.raycing.screens as rscreens
import xrt.backends.raycing.materials as rmats
import xrt.backends.raycing.materials_elemental as rmatsel
import xrt.backends.raycing.materials_compounds as rmatsco
import xrt.backends.raycing.materials_crystals as rmatscr
import xrt.backends.raycing.oes as roes
import xrt.backends.raycing.apertures as rapts
import xrt.backends.raycing.run as rrun
import xrt.backends.raycing as raycing
import xrt.plotter as xrtplot
import xrt.runner as xrtrun

m1_pitch = 30e-3
em_p = 5000
em_q = 1000

src_y = -em_p * np.cos(m1_pitch)
src_z = em_p * np.sin(m1_pitch)

scr_y = em_q * np.cos(m1_pitch)
scr_z = em_q * np.sin(m1_pitch)

src_dx = 212e-6
src_dz = 212e-6

src_dxprime = 2e-3
src_dzprime = 2e-3

#print(f"SCR center: [0.000, {em_p+scr_y:.3f}, {scr_z:.3f}]" )


def build_beamline():
    beamLine = raycing.BeamLine()

    beamLine.geometricSource = rsources.GeometricSource(
        bl=beamLine,
        name="GS",
        center=[0, src_y, src_z],
        pitch=-m1_pitch,
        dx=src_dx,
        dz=src_dz,
        dxprime=src_dxprime,
        dzprime=src_dzprime)

    beamLine.mirror = roes.EllipticalMirrorParam(
        bl=beamLine,
        name="EM",
        center=[0, 0, 0],
#        pitch=0,
        pitch=m1_pitch,
        extraPitch=-m1_pitch,
#        limPhysX=[-50.0, 50.0],
#        limPhysY=[-1200.0, 1200.0],
        limPhysX=[-10.0, 10.0],
        limPhysY=[-500.0, 500.0],
#        f1=[0, src_y, src_z],
#        f2=[0, scr_y, scr_z]

        p=em_p,
        q=em_q
        )

    beamLine.screen = rscreens.Screen(
        bl=beamLine,
        name="SCR",
        center=[0, scr_y, scr_z])

    return beamLine


def run_process(beamLine):
    geometricSource01beamGlobal01 = beamLine.geometricSource.shine()

    ellipticalMirrorParam01beamGlobal01, ellipticalMirrorParam01beamLocal01 = beamLine.mirror.reflect(
        beam=geometricSource01beamGlobal01)

    screen01beamLocal01 = beamLine.screen.expose(
        beam=ellipticalMirrorParam01beamGlobal01)

    outDict = {
        'geometricSource01beamGlobal01': geometricSource01beamGlobal01,
        'ellipticalMirrorParam01beamGlobal01': ellipticalMirrorParam01beamGlobal01,
        'ellipticalMirrorParam01beamLocal01': ellipticalMirrorParam01beamLocal01,
        'screen01beamLocal01': screen01beamLocal01}
    beamLine.prepare_flow()
    return outDict


rrun.run_process = run_process



def define_plots():
    plots = []

    Source = xrtplot.XYCPlot(
        beam=r"geometricSource01beamGlobal01",
        xaxis=xrtplot.XYCAxis(
            label=r"x",
            fwhmFormatStr=r"%.3f",
            limits=[-1000, 1000],
            unit="nm",
            factor=1e6),
        yaxis=xrtplot.XYCAxis(
            label=r"z",
            fwhmFormatStr=r"%.3f",
            limits=[-1000+src_z*1e6, 1000+src_z*1e6],
            offset=src_z*1e6,
            unit="nm",
            factor=1e6),
        caxis=xrtplot.XYCAxis(
            label=r"energy",
            unit=r"eV"),
        title=r"Source",
        aspect="equal")
    plots.append(Source)

    Footprint = xrtplot.XYCPlot(
        beam=r"ellipticalMirrorParam01beamLocal01",
        xaxis=xrtplot.XYCAxis(
            label=r"x",
            fwhmFormatStr=r"%.3f"),
        yaxis=xrtplot.XYCAxis(
            label=r"y",
            fwhmFormatStr=r"%.3f"),
        caxis=xrtplot.XYCAxis(
            label=r"energy",
            unit=r"eV"),
        title=r"Footprint",
        aspect="auto")
    plots.append(Footprint)

    Focus = xrtplot.XYCPlot(
        beam=r"screen01beamLocal01",
        xaxis=xrtplot.XYCAxis(
            label=r"x",
            fwhmFormatStr=r"%.3f",
#            limits=[-200, 200],
            unit="nm",
            factor=1e6),
        yaxis=xrtplot.XYCAxis(
            label=r"z",
            fwhmFormatStr=r"%.3f",
#            limits=[-200, 200],
            unit="nm",
            factor=1e6),
        caxis=xrtplot.XYCAxis(
            label=r"energy",
            unit=r"eV"),
        aspect=r"equal",
        title=r"Focus")
    plots.append(Focus)

    return plots


def main():
    beamLine = build_beamline()
    beamLine.glow()
    E0 = list(beamLine.geometricSource.energies)[0]
    beamLine.alignE=E0
    plots = define_plots()
    xrtrun.run_ray_tracing(
        plots=plots,
        repeats=20,
        processes=4,
        backend=r"raycing",
        beamLine=beamLine)


if __name__ == '__main__':
    main()
